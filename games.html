<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rock Paper Scissors vs Computer</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
    button.choice { padding: 15px 25px; margin: 10px; font-size: 1.2em; cursor: pointer; }
    select, .startBtn { margin: 10px; padding: 8px 12px; }
    #status { font-weight: bold; margin-top: 20px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Rock Paper Scissors</h1>

  <div id="userSetup">
    <label for="playerSelect">Choose your username:</label>
    <select id="playerSelect">
      <option value="">-- Select --</option>
      <option value="lefa">Lefa</option>
      <option value="jonas">Jonas</option>
      <option value="owami">Owami</option>
      <option value="preasx24">Preasx24</option>
    </select>
    <button class="startBtn" onclick="startGame()">Start Game</button>
  </div>

  <p id="playerInfo"></p>
  <div id="choices" style="display:none;">
    <button class="choice" onclick="play('rock')">‚úä Rock</button>
    <button class="choice" onclick="play('paper')">‚úã Paper</button>
    <button class="choice" onclick="play('scissors')">‚úåÔ∏è Scissors</button>
  </div>
  <p id="status">Please select a username and press Start.</p>
  <p id="score"></p>

  <script>
    const userGistMap = {
      lefa: { id: "02e300379f8b968942ac67379f5bc831", file: "gist_1.json" },
      jonas: { id: "69f058ad6bcb25e41d8b797dc7395c6d", file: "gist_2.json" },
      owami: { id: "6c9e9fcda5ed38f9839c9ac8bc147ba7", file: "gist_3.json" },
      preasx24: { id: "50e60ff2c3bc108d63038c8eb6c26e8d", file: "gist_4.json" }
    };

    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let token = null, player = null, gistInfo = null, playerData = null;

    const statusDiv = document.getElementById("status");
    const scoreDiv = document.getElementById("score");
    const choicesDiv = document.getElementById("choices");
    const playerInfo = document.getElementById("playerInfo");

    async function startGame() {
      player = document.getElementById("playerSelect").value;
      if (!player) return alert("Please choose a username");
      gistInfo = userGistMap[player];
      token = await fetchToken();
      await loadPlayerData();

      // init dailyGames tracker if missing
      if (!playerData.gameData.rps.dailyGames) {
        playerData.gameData.rps.dailyGames = { date: new Date().toDateString(), count: 0 };
        await savePlayerData();
      }

      // lock username choice
      document.getElementById("userSetup").style.display = "none";
      playerInfo.textContent = `Playing as: ${player}`;
      choicesDiv.style.display = "block";

      renderScore();
      statusDiv.textContent = "Make your move!";
    }

    function renderScore() {
      const g = playerData.gameData.rps;
      scoreDiv.textContent = `Score: ${g.score}, Total: ${playerData.gameData.totalScore}, Games today: ${g.dailyGames.count}/10`;
    }

    async function play(playerChoice) {
      const g = playerData.gameData.rps;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }
      if (g.dailyGames.count >= 10) {
        statusDiv.textContent = "üö´ Daily limit reached (10 games). Come back tomorrow!";
        return;
      }

      const choices = ["rock","paper","scissors"];
      const computerChoice = choices[Math.floor(Math.random() * 3)];
      let result = "";

      if (playerChoice === computerChoice) result = "ü§ù It's a draw!";
      else if (
        (playerChoice === "rock" && computerChoice === "scissors") ||
        (playerChoice === "paper" && computerChoice === "rock") ||
        (playerChoice === "scissors" && computerChoice === "paper")
      ) {
        result = `üéâ You Win! (${playerChoice} beats ${computerChoice})`;
        g.score += 1;
        playerData.gameData.totalScore += 1;
      } else {
        result = `üíª Computer Wins! (${computerChoice} beats ${playerChoice})`;
      }

      g.lastPlayed = today;
      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();
      await savePlayerData();

      statusDiv.textContent = result;
      renderScore();

      // auto reset message
      setTimeout(() => {
        if (g.dailyGames.count >= 10) {
          statusDiv.textContent = "üö´ Daily limit reached (10 games). Come back tomorrow!";
        } else {
          statusDiv.textContent = "Make your move!";
        }
      }, 1500);
    }

    // --- GIST FUNCTIONS ---
    async function fetchToken() {
      const res = await fetch(GIST_TOKEN_URL);
      return res.text();
    }

    async function loadPlayerData() {
      const res = await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const gist = await res.json();
      playerData = JSON.parse(gist.files[gistInfo.file].content);
    }

    async function savePlayerData() {
      const body = { files: { [gistInfo.file]: { content: JSON.stringify(playerData, null, 2) } } };
      await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }
  </script>
</body>
</html>