<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe vs Computer</title>
  <style>
    :root {
      --primary: #4a6fa5;
      --secondary: #166088;
      --accent: #4cb5f5;
      --background: #f8f9fa;
      --text: #333;
      --x-color: #ff6b6b;
      --o-color: #4cb5f5;
      --board-bg: #e9ecef;
      --cell-bg: #ffffff;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--background) 0%, #e6f2ff 100%);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow);
      padding: 25px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    h1 {
      color: var(--primary);
      margin-top: 0;
      font-size: 2.2rem;
      text-shadow: 1px 1px 2px var(--shadow);
    }

    #userSetup {
      background: var(--background);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--secondary);
    }

    select, button {
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 1rem;
      margin: 5px;
      transition: all 0.2s ease;
    }

    select {
      width: 200px;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow);
    }

    #playerInfo {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--secondary);
      margin: 15px 0;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px auto;
      max-width: 330px;
    }

    .cell {
      width: 100px;
      height: 100px;
      background: var(--cell-bg);
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cell:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px var(--shadow);
    }

    .cell.x {
      color: var(--x-color);
    }

    .cell.o {
      color: var(--o-color);
    }

    .cell.win {
      background-color: #e8f5e9;
      box-shadow: 0 0 15px #a5d6a7;
    }

    #status {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 15px 0;
      min-height: 30px;
      color: var(--secondary);
    }

    #score {
      background: var(--background);
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      margin: 15px 0;
    }

    .win-message {
      color: #2e7d32;
      font-size: 1.4rem;
      animation: pulse 1s infinite;
    }

    .loss-message {
      color: #c62828;
    }

    .draw-message {
      color: #757575;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 500px) {
      .container {
        padding: 15px;
      }
      
      .cell {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tic Tac Toe vs Computer</h1>

    <div id="userSetup">
      <label for="playerSelect">Choose your username:</label>
      <select id="playerSelect">
        <option value="">-- Select --</option>
        <option value="lefa">Lefa</option>
        <option value="jonas">Jonas</option>
        <option value="owami">Owami</option>
        <option value="preasx24">Preasx24</option>
      </select>
      <button onclick="startGame()">Start Game</button>
    </div>

    <p id="playerInfo"></p>
    <div id="board"></div>
    <p id="status">Please select a username and press Start.</p>
    <p id="score"></p>
  </div>

  <script>
    const userGistMap = {
      lefa: { id: "02e300379f8b968942ac67379f5bc831", file: "gist_1.json" },
      jonas: { id: "69f058ad6bcb25e41d8b797dc7395c6d", file: "gist_2.json" },
      owami: { id: "6c9e9fcda5ed38f9839c9ac8bc147ba7", file: "gist_3.json" },
      preasx24: { id: "50e60ff2c3bc108d63038c8eb6c26e8d", file: "gist_4.json" }
    };

    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let board = Array(9).fill(null);
    let currentPlayer = "X"; // X = human
    let player = null, gistInfo = null, token = null, playerData = null;
    let gameActive = false;
    const boardDiv = document.getElementById("board");
    const statusDiv = document.getElementById("status");
    const scoreDiv = document.getElementById("score");
    const playerInfo = document.getElementById("playerInfo");

    async function startGame() {
      player = document.getElementById("playerSelect").value;
      if (!player) return alert("Please choose a username");
      gistInfo = userGistMap[player];
      token = await fetchToken();
      await loadPlayerData();

      // ðŸ”¹ initialize dailyGames tracker if missing
      if (!playerData.gameData.ticTacToe.dailyGames) {
        playerData.gameData.ticTacToe.dailyGames = { date: new Date().toDateString(), count: 0 };
      }
      await savePlayerData();

      // ðŸ”¹ lock username choice
      document.getElementById("userSetup").style.display = "none";
      playerInfo.textContent = `Playing as: ${player}`;

      resetBoard();
      gameActive = true;
      renderBoard();
      statusDiv.textContent = "Your turn (X)";
      statusDiv.className = "";
    }

    function resetBoard() {
      board = Array(9).fill(null);
      currentPlayer = "X";
      gameActive = true;
      renderBoard();
    }

    function renderBoard() {
      boardDiv.innerHTML = "";
      board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = `cell ${cell === 'X' ? 'x' : cell === 'O' ? 'o' : ''}`;
        div.textContent = cell || "";
        div.onclick = () => makeMove(i);
        boardDiv.appendChild(div);
      });
      
      if (playerData) {
        const g = playerData.gameData.ticTacToe;
        scoreDiv.textContent = `Score: ${g.score} | Total: ${playerData.gameData.totalScore} | Games today: ${g.dailyGames.count}/10`;
      }
    }

    function makeMove(i) {
      if (!player || !gameActive || board[i] || checkWinner() || currentPlayer !== "X") return;
      
      board[i] = "X";
      currentPlayer = "O";
      renderBoard();

      const winner = checkWinner();
      if (winner) {
        endGame(winner);
        return;
      }

      setTimeout(computerMove, 600); // Slight delay for better UX
    }

    function computerMove() {
      if (!gameActive) return;
      
      // Get best move using minimax algorithm
      let move = getBestMove();
      
      board[move] = "O";
      currentPlayer = "X";
      renderBoard();

      const winner = checkWinner();
      if (winner) endGame(winner);
    }

    function getBestMove() {
      // Check if computer can win in the next move
      for (let i = 0; i < 9; i++) {
        if (board[i] === null) {
          board[i] = "O";
          if (checkWinner() === "O") {
            board[i] = null;
            return i;
          }
          board[i] = null;
        }
      }

      // Check if player can win in the next move and block
      for (let i = 0; i < 9; i++) {
        if (board[i] === null) {
          board[i] = "X";
          if (checkWinner() === "X") {
            board[i] = null;
            return i;
          }
          board[i] = null;
        }
      }

      // Try to take center if available
      if (board[4] === null) return 4;

      // Try to take corners if available
      const corners = [0, 2, 6, 8];
      const availableCorners = corners.filter(i => board[i] === null);
      if (availableCorners.length > 0) {
        return availableCorners[Math.floor(Math.random() * availableCorners.length)];
      }

      // Take any available edge
      const edges = [1, 3, 5, 7];
      const availableEdges = edges.filter(i => board[i] === null);
      if (availableEdges.length > 0) {
        return availableEdges[Math.floor(Math.random() * availableEdges.length)];
      }

      // Fallback (shouldn't happen if board isn't full)
      return board.findIndex(cell => cell === null);
    }

    function checkWinner() {
      const wins = [[0,1,2],[3,4,5],[6,7,8],
                    [0,3,6],[1,4,7],[2,5,8],
                    [0,4,8],[2,4,6]];
      
      for (const [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          // Highlight winning cells
          setTimeout(() => {
            document.querySelectorAll('.cell')[a].classList.add('win');
            document.querySelectorAll('.cell')[b].classList.add('win');
            document.querySelectorAll('.cell')[c].classList.add('win');
          }, 10);
          
          return board[a];
        }
      }
      
      // Check for draw
      if (!board.includes(null)) return "draw";
      
      return null;
    }

    async function endGame(winner) {
      gameActive = false;
      let msg = "";
      
      if (winner === "X") { 
        msg = "ðŸŽ‰ You Win!"; 
        statusDiv.className = "win-message";
        await updateScore(); 
      }
      else if (winner === "O") {
        msg = "ðŸ’» Computer Wins!";
        statusDiv.className = "loss-message";
      }
      else {
        msg = "ðŸ¤ Draw!";
        statusDiv.className = "draw-message";
      }

      statusDiv.textContent = msg;

      setTimeout(() => {
        if (playerData.gameData.ticTacToe.dailyGames.count >= 10) {
          statusDiv.textContent = "ðŸš« Daily limit reached (10 games). Come back tomorrow!";
          boardDiv.innerHTML = "";
        } else {
          resetBoard();
          statusDiv.textContent = "Your turn (X)";
          statusDiv.className = "";
        }
      }, 2000);
    }

    // --- GIST STUFF ---
    async function fetchToken() {
      const res = await fetch(GIST_TOKEN_URL);
      return res.text();
    }

    async function loadPlayerData() {
      const res = await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const gist = await res.json();
      playerData = JSON.parse(gist.files[gistInfo.file].content);
    }

    async function savePlayerData() {
      const body = { files: { [gistInfo.file]: { content: JSON.stringify(playerData, null, 2) } } };
      await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    async function updateScore() {
      const g = playerData.gameData.ticTacToe;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }

      if (g.dailyGames.count >= 10) return; // limit reached

      g.score += 1;
      playerData.gameData.totalScore += 1;
      g.lastPlayed = today;
      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();

      await savePlayerData();
      renderBoard();
    }
  </script>
</body>
</html>