<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Memory Card Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
    #gameBoard { 
      display: grid; 
      grid-template-columns: repeat(4, 80px); 
      gap: 10px; 
      justify-content: center; 
      margin: 20px auto; 
    }
    .card {
      width: 80px; height: 100px; 
      background: #444; color: white; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 2em; cursor: pointer; border-radius: 8px; 
    }
    .flipped { background: #fff; color: #000; cursor: default; }
    select, .startBtn { margin: 10px; padding: 8px 12px; }
    #status { font-weight: bold; margin-top: 20px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Memory Card Game</h1>

  <div id="userSetup">
    <label for="playerSelect">Choose your username:</label>
    <select id="playerSelect">
      <option value="">-- Select --</option>
      <option value="lefa">Lefa</option>
      <option value="jonas">Jonas</option>
      <option value="owami">Owami</option>
      <option value="preasx24">Preasx24</option>
    </select>
    <button class="startBtn" onclick="startGame()">Start Game</button>
  </div>

  <p id="playerInfo"></p>
  <div id="gameBoard"></div>
  <p id="status">Please select a username and press Start.</p>
  <p id="score"></p>

  <script>
    const userGistMap = {
      lefa: { id: "02e300379f8b968942ac67379f5bc831", file: "gist_1.json" },
      jonas: { id: "69f058ad6bcb25e41d8b797dc7395c6d", file: "gist_2.json" },
      owami: { id: "6c9e9fcda5ed38f9839c9ac8bc147ba7", file: "gist_3.json" },
      preasx24: { id: "50e60ff2c3bc108d63038c8eb6c26e8d", file: "gist_4.json" }
    };

    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let token = null, player = null, gistInfo = null, playerData = null;
    let flippedCards = [], lockBoard = false, matchesFound = 0;

    const boardDiv = document.getElementById("gameBoard");
    const statusDiv = document.getElementById("status");
    const scoreDiv = document.getElementById("score");
    const playerInfo = document.getElementById("playerInfo");

    const emojis = ["ðŸŽ","ðŸŒ","ðŸ“","ðŸ‡","ðŸŠ","ðŸ‰","ðŸ’","ðŸ"];

    async function startGame() {
      player = document.getElementById("playerSelect").value;
      if (!player) return alert("Please choose a username");
      gistInfo = userGistMap[player];
      token = await fetchToken();
      await loadPlayerData();

      // init dailyGames tracker if missing
      if (!playerData.gameData.memory.dailyGames) {
        playerData.gameData.memory.dailyGames = { date: new Date().toDateString(), count: 0 };
        await savePlayerData();
      }

      // lock username choice
      document.getElementById("userSetup").style.display = "none";
      playerInfo.textContent = `Playing as: ${player}`;

      startNewRound();
    }

    function startNewRound() {
      const g = playerData.gameData.memory;
      const today = new Date().toDateString();
      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }
      if (g.dailyGames.count >= 10) {
        boardDiv.innerHTML = "";
        statusDiv.textContent = "ðŸš« Daily limit reached (10 games). Come back tomorrow!";
        renderScore();
        return;
      }

      matchesFound = 0;
      flippedCards = [];
      lockBoard = false;

      // create card pairs
      let cards = [...emojis, ...emojis];
      cards.sort(() => Math.random() - 0.5);

      boardDiv.innerHTML = "";
      cards.forEach((emoji, i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.value = emoji;
        card.onclick = () => flipCard(card);
        boardDiv.appendChild(card);
      });

      renderScore();
      statusDiv.textContent = "Find all pairs!";
    }

    function flipCard(card) {
      if (lockBoard || card.classList.contains("flipped")) return;
      card.textContent = card.dataset.value;
      card.classList.add("flipped");
      flippedCards.push(card);

      if (flippedCards.length === 2) {
        checkMatch();
      }
    }

    async function checkMatch() {
      lockBoard = true;
      const [c1, c2] = flippedCards;
      if (c1.dataset.value === c2.dataset.value) {
        statusDiv.textContent = "âœ… Match!";
        matchesFound++;
        await updateScore();
        resetFlipped();
        if (matchesFound === emojis.length) {
          statusDiv.textContent = "ðŸŽ‰ You cleared the board!";
          setTimeout(startNewRound, 1500);
        }
      } else {
        statusDiv.textContent = "âŒ No match!";
        setTimeout(() => {
          c1.textContent = "";
          c1.classList.remove("flipped");
          c2.textContent = "";
          c2.classList.remove("flipped");
          resetFlipped();
        }, 1000);
      }
    }

    function resetFlipped() {
      flippedCards = [];
      lockBoard = false;
    }

    function renderScore() {
      const g = playerData.gameData.memory;
      scoreDiv.textContent = `Score: ${g.score}, Total: ${playerData.gameData.totalScore}, Games today: ${g.dailyGames.count}/10`;
    }

    // --- GIST STUFF ---
    async function fetchToken() {
      const res = await fetch(GIST_TOKEN_URL);
      return res.text();
    }

    async function loadPlayerData() {
      const res = await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const gist = await res.json();
      playerData = JSON.parse(gist.files[gistInfo.file].content);
    }

    async function savePlayerData() {
      const body = { files: { [gistInfo.file]: { content: JSON.stringify(playerData, null, 2) } } };
      await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    async function updateScore() {
      const g = playerData.gameData.memory;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }

      if (g.dailyGames.count >= 10) return;

      g.score += 1;
      playerData.gameData.totalScore += 1;
      g.lastPlayed = today;
      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();

      await savePlayerData();
      renderScore();
    }
  </script>
</body>
</html>