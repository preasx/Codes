<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe vs Computer</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
    #board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; margin: 20px auto; }
    .cell { width: 100px; height: 100px; background: #eee; font-size: 2em;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; border: 2px solid #333; }
    select, button { margin: 10px; padding: 8px 12px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Tic Tac Toe vs Computer</h1>

  <div id="userSetup">
    <label for="playerSelect">Choose your username:</label>
    <select id="playerSelect">
      <option value="">-- Select --</option>
      <option value="lefa">Lefa</option>
      <option value="jonas">Jonas</option>
      <option value="owami">Owami</option>
      <option value="preasx24">Preasx24</option>
    </select>
    <button onclick="startGame()">Start Game</button>
  </div>

  <p id="playerInfo"></p>
  <div id="board"></div>
  <p id="status">Please select a username and press Start.</p>
  <p id="score"></p>

  <script>
    const userGistMap = {
      lefa: { id: "02e300379f8b968942ac67379f5bc831", file: "gist_1.json" },
      jonas: { id: "69f058ad6bcb25e41d8b797dc7395c6d", file: "gist_2.json" },
      owami: { id: "6c9e9fcda5ed38f9839c9ac8bc147ba7", file: "gist_3.json" },
      preasx24: { id: "50e60ff2c3bc108d63038c8eb6c26e8d", file: "gist_4.json" }
    };

    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let board = Array(9).fill(null);
    let currentPlayer = "X"; // X = human
    let player = null, gistInfo = null, token = null, playerData = null;
    const boardDiv = document.getElementById("board");
    const statusDiv = document.getElementById("status");
    const scoreDiv = document.getElementById("score");
    const playerInfo = document.getElementById("playerInfo");

    async function startGame() {
      player = document.getElementById("playerSelect").value;
      if (!player) return alert("Please choose a username");
      gistInfo = userGistMap[player];
      token = await fetchToken();
      await loadPlayerData();

      // 🔹 initialize dailyGames tracker if missing
      if (!playerData.gameData.ticTacToe.dailyGames) {
        playerData.gameData.ticTacToe.dailyGames = { date: new Date().toDateString(), count: 0 };
      }
      await savePlayerData();

      // 🔹 lock username choice
      document.getElementById("userSetup").style.display = "none";
      playerInfo.textContent = `Playing as: ${player}`;

      resetBoard();
      renderBoard();
      statusDiv.textContent = "Your turn (X)";
    }

    function resetBoard() {
      board = Array(9).fill(null);
      currentPlayer = "X";
      renderBoard();
    }

    function renderBoard() {
      boardDiv.innerHTML = "";
      board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "cell";
        div.textContent = cell || "";
        div.onclick = () => makeMove(i);
        boardDiv.appendChild(div);
      });
      if (playerData) {
        const g = playerData.gameData.ticTacToe;
        scoreDiv.textContent = `Score: ${g.score}, Total: ${playerData.gameData.totalScore}, Games today: ${g.dailyGames.count}/10`;
      }
    }

    function makeMove(i) {
      if (!player || board[i] || checkWinner() || currentPlayer !== "X") return;
      board[i] = "X";
      currentPlayer = "O";
      renderBoard();

      const winner = checkWinner();
      if (winner) return endGame(winner);

      setTimeout(computerMove, 500);
    }

    function computerMove() {
      let empty = board.map((v, i) => v ? null : i).filter(v => v !== null);
      if (empty.length === 0) return endGame("draw");
      let move = empty[Math.floor(Math.random() * empty.length)];
      board[move] = "O";
      currentPlayer = "X";
      renderBoard();

      const winner = checkWinner();
      if (winner) endGame(winner);
    }

    function checkWinner() {
      const wins = [[0,1,2],[3,4,5],[6,7,8],
                    [0,3,6],[1,4,7],[2,5,8],
                    [0,4,8],[2,4,6]];
      for (const [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      return null;
    }

    async function endGame(winner) {
      let msg = "";
      if (winner === "X") { msg = "🎉 You Win!"; await updateScore(); }
      else if (winner === "O") msg = "💻 Computer Wins!";
      else msg = "🤝 Draw!";

      statusDiv.textContent = msg;

      setTimeout(() => {
        if (playerData.gameData.ticTacToe.dailyGames.count >= 10) {
          statusDiv.textContent = "🚫 Daily limit reached (10 games). Come back tomorrow!";
          boardDiv.innerHTML = "";
        } else {
          resetBoard();
          statusDiv.textContent = "Your turn (X)";
        }
      }, 1500);
    }

    // --- GIST STUFF ---
    async function fetchToken() {
      const res = await fetch(GIST_TOKEN_URL);
      return res.text();
    }

    async function loadPlayerData() {
      const res = await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const gist = await res.json();
      playerData = JSON.parse(gist.files[gistInfo.file].content);
    }

    async function savePlayerData() {
      const body = { files: { [gistInfo.file]: { content: JSON.stringify(playerData, null, 2) } } };
      await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
        method: "PATCH",
        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    async function updateScore() {
      const g = playerData.gameData.ticTacToe;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }

      if (g.dailyGames.count >= 10) return; // limit reached

      g.score += 1;
      playerData.gameData.totalScore += 1;
      g.lastPlayed = today;
      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();

      await savePlayerData();
      renderBoard();
    }
  </script>
</body>
</html>