<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Tic Tac Toe</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #fff;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      grid-column: 1 / -1;
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .tagline {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .game-info {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .player-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .player-card h3 {
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .stat {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 8px;
    }

    .setup-panel {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .setup-panel h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    select, button {
      padding: 12px 15px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select {
      width: 100%;
    }

    button {
      background: #4a6fa5;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: #5d84be;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    .game-board {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 0 auto;
      max-width: 400px;
      width: 100%;
    }

    .cell {
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .cell:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-3px);
    }

    .cell.x {
      color: #ff6b6b;
    }

    .cell.o {
      color: #4cb5f5;
    }

    .cell.win {
      background: rgba(76, 181, 245, 0.3);
      box-shadow: 0 0 20px rgba(76, 181, 245, 0.5);
    }

    #status {
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 20px;
      border-radius: 50px;
      margin-top: 10px;
    }

    .win-message {
      color: #a5d6a7;
      text-shadow: 0 0 10px rgba(165, 214, 167, 0.5);
    }

    .loss-message {
      color: #ff6b6b;
    }

    .draw-message {
      color: #ffe082;
    }

    .score-display {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 10px;
    }

    .score-box {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .score-box h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }

    .score-value {
      font-size: 2rem;
      font-weight: bold;
    }

    .trophy {
      color: gold;
      margin-right: 5px;
    }

    .history {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .history h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 150px;
      overflow-y: auto;
    }

    .history-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 2.2rem;
      }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-gamepad"></i> Tic Tac Toe</h1>
      <p class="tagline">Challenge the computer in this classic game!</p>
    </header>

    <div class="game-info">
      <div class="player-card">
        <h3><i class="fas fa-user"></i> Player</h3>
        <div class="stats">
          <div class="stat">Wins: <span id="wins">0</span></div>
          <div class="stat">Losses: <span id="losses">0</span></div>
          <div class="stat">Draws: <span id="draws">0</span></div>
          <div class="stat">Total: <span id="total">0</span></div>
        </div>
      </div>
      
      <div class="player-card">
        <h3><i class="fas fa-robot"></i> Computer</h3>
        <div class="stats">
          <div class="stat">Difficulty: <span>Expert</span></div>
          <div class="stat">Strategy: <span>Adaptive</span></div>
        </div>
      </div>
    </div>

    <div class="setup-panel">
      <h2><i class="fas fa-cog"></i> Game Setup</h2>
      <select id="playerSelect">
        <option value="">-- Select Username --</option>
        <option value="lefa">Lefa</option>
        <option value="jonas">Jonas</option>
        <option value="owami">Owami</option>
        <option value="preasx24">Preasx24</option>
      </select>
      <button onclick="startGame()"><i class="fas fa-play"></i> Start Game</button>
      <button onclick="resetGame()"><i class="fas fa-redo"></i> Reset Board</button>
    </div>

    <div class="game-board">
      <div id="board"></div>
      <div id="status">Select your username and start the game</div>
    </div>

    <div class="score-display">
      <div class="score-box">
        <h3><i class="fas fa-trophy trophy"></i> Score</h3>
        <div class="score-value" id="score">0</div>
      </div>
      <div class="score-box">
        <h3><i class="fas fa-star trophy"></i> Total Score</h3>
        <div class="score-value" id="total-score">0</div>
      </div>
      <div class="score-box">
        <h3><i class="fas fa-calendar-day trophy"></i> Games Today</h3>
        <div class="score-value" id="daily-games">0/10</div>
      </div>
    </div>

    <div class="history">
      <h2><i class="fas fa-history"></i> Game History</h2>
      <div class="history-list" id="history-list">
        <div class="history-item">No games played yet</div>
      </div>
    </div>
  </div>

  <script>
    const userGistMap = {
      lefa: { id: "02e300379f8b968942ac67379f5bc831", file: "gist_1.json" },
      jonas: { id: "69f058ad6bcb25e41d8b797dc7395c6d", file: "gist_2.json" },
      owami: { id: "6c9e9fcda5ed38f9839c9ac8bc147ba7", file: "gist_3.json" },
      preasx24: { id: "50e60ff2c3bc108d63038c8eb6c26e8d", file: "gist_4.json" }
    };

    const GIST_TOKEN_URL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let board = Array(9).fill(null);
    let currentPlayer = "X"; // X = human
    let player = null, gistInfo = null, token = null, playerData = null;
    let gameActive = false;
    let wins = 0, losses = 0, draws = 0, totalGames = 0;
    const boardDiv = document.getElementById("board");
    const statusDiv = document.getElementById("status");
    const scoreDiv = document.getElementById("score");
    const totalScoreDiv = document.getElementById("total-score");
    const dailyGamesDiv = document.getElementById("daily-games");
    const historyList = document.getElementById("history-list");
    const winsSpan = document.getElementById("wins");
    const lossesSpan = document.getElementById("losses");
    const drawsSpan = document.getElementById("draws");
    const totalSpan = document.getElementById("total");

    async function startGame() {
      player = document.getElementById("playerSelect").value;
      if (!player) return alert("Please choose a username");
      gistInfo = userGistMap[player];
      token = await fetchToken();
      await loadPlayerData();

      // Initialize dailyGames tracker if missing
      if (!playerData.gameData.ticTacToe.dailyGames) {
        playerData.gameData.ticTacToe.dailyGames = { date: new Date().toDateString(), count: 0 };
      }
      
      // Initialize game history if missing
      if (!playerData.gameData.ticTacToe.history) {
        playerData.gameData.ticTacToe.history = [];
      }
      
      await savePlayerData();

      resetBoard();
      gameActive = true;
      renderBoard();
      updateStats();
      statusDiv.textContent = "Your turn (X)";
      statusDiv.className = "";
    }

    function resetBoard() {
      board = Array(9).fill(null);
      currentPlayer = "X";
      gameActive = true;
      renderBoard();
    }

    function resetGame() {
      if (!player) return alert("Please select a username first");
      resetBoard();
      statusDiv.textContent = "Game reset. Your turn (X)";
    }

    function renderBoard() {
      boardDiv.innerHTML = "";
      board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = `cell ${cell === 'X' ? 'x' : cell === 'O' ? 'o' : ''}`;
        div.textContent = cell || "";
        div.onclick = () => makeMove(i);
        boardDiv.appendChild(div);
      });
      
      if (playerData) {
        const g = playerData.gameData.ticTacToe;
        scoreDiv.textContent = g.score;
        totalScoreDiv.textContent = playerData.gameData.totalScore;
        dailyGamesDiv.textContent = `${g.dailyGames.count}/10`;
      }
    }

    function updateStats() {
      winsSpan.textContent = wins;
      lossesSpan.textContent = losses;
      drawsSpan.textContent = draws;
      totalSpan.textContent = totalGames;
    }

    function updateHistory(outcome) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      const historyItem = document.createElement("div");
      historyItem.className = "history-item";
      
      if (outcome === "win") {
        historyItem.innerHTML = `<span>${time} - Win vs Computer</span> <span>+1 point</span>`;
      } else if (outcome === "lose") {
        historyItem.innerHTML = `<span>${time} - Loss vs Computer</span> <span>No points</span>`;
      } else {
        historyItem.innerHTML = `<span>${time} - Draw vs Computer</span> <span>No points</span>`;
      }
      
      historyList.prepend(historyItem);
      
      // Keep only the last 5 history items
      if (historyList.children.length > 5) {
        historyList.removeChild(historyList.lastChild);
      }
    }

    function makeMove(i) {
      if (!player || !gameActive || board[i] || checkWinner() || currentPlayer !== "X") return;
      
      board[i] = "X";
      currentPlayer = "O";
      renderBoard();

      const winner = checkWinner();
      if (winner) {
        endGame(winner);
        return;
      }

      setTimeout(computerMove, 600);
    }

    function computerMove() {
      if (!gameActive) return;
      
      // Get best move using minimax algorithm
      let move = getBestMove();
      
      board[move] = "O";
      currentPlayer = "X";
      renderBoard();

      const winner = checkWinner();
      if (winner) endGame(winner);
    }

    function getBestMove() {
      // Check if computer can win in the next move
      for (let i = 0; i < 9; i++) {
        if (board[i] === null) {
          board[i] = "O";
          if (checkWinner() === "O") {
            board[i] = null;
            return i;
          }
          board[i] = null;
        }
      }

      // Check if player can win in the next move and block
      for (let i = 0; i < 9; i++) {
        if (board[i] === null) {
          board[i] = "X";
          if (checkWinner() === "X") {
            board[i] = null;
            return i;
          }
          board[i] = null;
        }
      }

      // Try to take center if available
      if (board[4] === null) return 4;

      // Try to take corners if available
      const corners = [0, 2, 6, 8];
      const availableCorners = corners.filter(i => board[i] === null);
      if (availableCorners.length > 0) {
        return availableCorners[Math.floor(Math.random() * availableCorners.length)];
      }

      // Take any available edge
      const edges = [1, 3, 5, 7];
      const availableEdges = edges.filter(i => board[i] === null);
      if (availableEdges.length > 0) {
        return availableEdges[Math.floor(Math.random() * availableEdges.length)];
      }

      // Fallback (shouldn't happen if board isn't full)
      return board.findIndex(cell => cell === null);
    }

    function checkWinner() {
      const wins = [[0,1,2],[3,4,5],[6,7,8],
                    [0,3,6],[1,4,7],[2,5,8],
                    [0,4,8],[2,4,6]];
      
      for (const [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          // Highlight winning cells
          setTimeout(() => {
            document.querySelectorAll('.cell')[a].classList.add('win');
            document.querySelectorAll('.cell')[b].classList.add('win');
            document.querySelectorAll('.cell')[c].classList.add('win');
          }, 10);
          
          return board[a];
        }
      }
      
      // Check for draw
      if (!board.includes(null)) return "draw";
      
      return null;
    }

    async function endGame(winner) {
      gameActive = false;
      let msg = "";
      let outcome = "";
      
      if (winner === "X") { 
        msg = "🎉 You Win!";
        outcome = "win";
        statusDiv.className = "win-message";
        wins++;
        totalGames++;
        await updateScore(); 
      }
      else if (winner === "O") {
        msg = "💻 Computer Wins!";
        outcome = "lose";
        statusDiv.className = "loss-message";
        losses++;
        totalGames++;
        await updateGameCount();
      }
      else {
        msg = "🤝 Draw!";
        outcome = "draw";
        statusDiv.className = "draw-message";
        draws++;
        totalGames++;
        await updateGameCount();
      }

      statusDiv.textContent = msg;
      updateStats();
      updateHistory(outcome);

      setTimeout(() => {
        if (playerData.gameData.ticTacToe.dailyGames.count >= 10) {
          statusDiv.textContent = "🚫 Daily limit reached (10 games). Come back tomorrow!";
          boardDiv.innerHTML = "";
        } else {
          resetBoard();
          statusDiv.textContent = "Your turn (X)";
          statusDiv.className = "";
        }
      }, 2000);
    }

    // --- GIST STUFF ---
    async function fetchToken() {
      const res = await fetch(GIST_TOKEN_URL);
      return res.text();
    }

    async function loadPlayerData() {
      try {
        const res = await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
          headers: { "Authorization": `token ${token}` }
        });
        const gist = await res.json();
        playerData = JSON.parse(gist.files[gistInfo.file].content);
        
        // Initialize stats from playerData if available
        wins = playerData.gameData.ticTacToe.wins || 0;
        losses = playerData.gameData.ticTacToe.losses || 0;
        draws = playerData.gameData.ticTacToe.draws || 0;
        totalGames = wins + losses + draws;
      } catch (error) {
        console.error("Error loading player data:", error);
        // Initialize with mock data for demonstration
        playerData = {
          gameData: {
            ticTacToe: {
              score: 0,
              wins: 0,
              losses: 0,
              draws: 0,
              dailyGames: { date: new Date().toDateString(), count: 0 },
              history: []
            },
            totalScore: 0
          }
        };
      }
    }

    async function savePlayerData() {
      // Update playerData with current stats
      playerData.gameData.ticTacToe.wins = wins;
      playerData.gameData.ticTacToe.losses = losses;
      playerData.gameData.ticTacToe.draws = draws;
      
      const body = { files: { [gistInfo.file]: { content: JSON.stringify(playerData, null, 2) } } };
      try {
        await fetch(`https://api.github.com/gists/${gistInfo.id}`, {
          method: "PATCH",
          headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      } catch (error) {
        console.error("Error saving player data:", error);
      }
    }

    async function updateScore() {
      const g = playerData.gameData.ticTacToe;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }

      if (g.dailyGames.count >= 10) return; // limit reached

      g.score += 1;
      playerData.gameData.totalScore += 1;
      g.lastPlayed = today;
      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();

      await savePlayerData();
      renderBoard();
    }

    async function updateGameCount() {
      const g = playerData.gameData.ticTacToe;
      const today = new Date().toDateString();

      if (g.dailyGames.date !== today) {
        g.dailyGames.date = today;
        g.dailyGames.count = 0;
      }

      if (g.dailyGames.count >= 10) return; // limit reached

      g.dailyGames.count += 1;
      playerData.lastUpdated = new Date().toISOString();

      await savePlayerData();
      renderBoard();
    }

    // Initialize the board on page load
    window.onload = function() {
      renderBoard();
    };
  </script>
</body>
</html>