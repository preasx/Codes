<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sacrifice Certificates</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    h1 { color:#333; }
    .section { background:#fff; padding:15px; margin:15px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    button { padding:8px 14px; margin:5px; border:none; border-radius:5px; cursor:pointer; background:#007bff; color:#fff; }
    button:hover { background:#0056b3; }
    input, select, textarea { padding:6px; margin:5px 0; width:100%; max-width:400px; }
    .sacrifice { border-bottom:1px solid #ddd; padding:8px 0; }
  </style>
</head>
<body>
  <h1>Sacrifice & Certificates</h1>

  <!-- LOGIN -->
  <div id="loginDiv" class="section" style="display:none;">
    <h2>Login / Register</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" style="display:none;">
    <div class="section">
      <h2>Welcome, <span id="userLabel"></span></h2>
      <p>Points: <span id="pointsLabel">0</span></p>
      <p>Partner: <span id="partnerLabel">None</span></p>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Assign partner if not set -->
    <div class="section" id="partnerDiv" style="display:none;">
      <h3>Choose Partner</h3>
      <select id="partnerSelect"></select>
      <button onclick="setPartner()">Set Partner</button>
    </div>

    <!-- Sacrifices Created for Partner -->
    <div class="section">
      <h3>My Sacrifices for Partner</h3>
      <div id="mySacrifices"></div>
      <h4>Create New Sacrifice</h4>
      <input id="sacrificeDesc" placeholder="Describe sacrifice">
      <input id="sacrificePoints" type="number" min="1" max="25" placeholder="Points (1-25)">
      <button onclick="createSacrifice()">Add Sacrifice</button>
    </div>

    <!-- Sacrifices Assigned to Me -->
    <div class="section">
      <h3>Sacrifices Assigned to Me</h3>
      <div id="assignedSacrifices"></div>
    </div>

    <!-- History -->
    <div class="section">
      <h3>Completed Sacrifices</h3>
      <div id="history"></div>
    </div>

    <!-- Certificates -->
    <div class="section">
      <h3>Certificates</h3>
      <select id="certType">
        <option value="10">10 Points – Simple Questions</option>
        <option value="20">20 Points – Date + Questions</option>
        <option value="30">30 Points – Serious Date & Deep Questions</option>
      </select>
      <textarea id="certContent" placeholder="Enter questions/dares (one per line)"></textarea>
      <input id="certPartner" placeholder="Partner name">
      <button onclick="buyCertificate()">Buy Certificate</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const gistId = "b8d0eca0d174ac6b5b59c2ced0a9e2ad";
    const filename = "gist_1.json";
    const tokenUrl = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let githubToken = "";
    let gistData = { users: {} };
    let currentUser = null;

    async function fetchToken() {
      const res = await fetch(tokenUrl);
      githubToken = (await res.text()).trim();
    }

    async function fetchGistData() {
      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: { Authorization: "token " + githubToken }
      });
      const gist = await res.json();
      const content = gist.files[filename]?.content || '{"users":{}}';
      return JSON.parse(content);
    }

    async function updateGist() {
      await fetch(`https://api.github.com/gists/${gistId}`, {
        method: "PATCH",
        headers: {
          Authorization: "token " + githubToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          files: { [filename]: { content: JSON.stringify(gistData, null, 2) } }
        })
      });
    }

    function logout() {
      localStorage.removeItem("currentUser");
      location.reload();
    }

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) return alert("Enter username & password");

      if (!gistData.users[username]) {
        gistData.users[username] = { password, points: 0, partner: null, sacrifices: [], history: [], certificates: [] };
      } else if (gistData.users[username].password !== password) {
        return alert("Wrong password");
      }

      currentUser = username;
      localStorage.setItem("currentUser", currentUser);
      await updateGist();
      showDashboard();
    }

    function showDashboard() {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("userLabel").innerText = currentUser;
      document.getElementById("pointsLabel").innerText = gistData.users[currentUser].points;

      const partner = gistData.users[currentUser].partner;
      if (!partner) {
        document.getElementById("partnerDiv").style.display = "block";
        const select = document.getElementById("partnerSelect");
        select.innerHTML = "";
        Object.keys(gistData.users).forEach(u => {
          if (u !== currentUser) {
            let opt = document.createElement("option");
            opt.value = u; opt.textContent = u;
            select.appendChild(opt);
          }
        });
      } else {
        document.getElementById("partnerLabel").innerText = partner;
        document.getElementById("partnerDiv").style.display = "none";
      }
      renderSacrifices();
      renderHistory();
    }

    async function setPartner() {
      const partner = document.getElementById("partnerSelect").value;
      gistData.users[currentUser].partner = partner;
      await updateGist();
      showDashboard();
    }

    async function createSacrifice() {
      const desc = document.getElementById("sacrificeDesc").value.trim();
      const pts = parseInt(document.getElementById("sacrificePoints").value);
      if (!desc || !pts) return;
      if (pts < 1 || pts > 25) return alert("Points must be between 1 and 25");
      const partner = gistData.users[currentUser].partner;
      if (!partner) return alert("No partner set");

      gistData.users[partner].sacrifices.push({ from: currentUser, desc, points: pts });
      await updateGist();
      renderSacrifices();
    }

    async function completeSacrifice(index) {
      const sac = gistData.users[currentUser].sacrifices[index];
      const fromUser = sac.from;
      gistData.users[fromUser].points += sac.points;
      gistData.users[fromUser].history.push({ desc: sac.desc, points: sac.points, by: currentUser });
      gistData.users[currentUser].sacrifices.splice(index, 1);
      await updateGist();
      showDashboard();
    }

    function renderSacrifices() {
      const me = gistData.users[currentUser];
      const partner = me.partner;
      const myDiv = document.getElementById("mySacrifices");
      myDiv.innerHTML = "";
      if (partner && gistData.users[partner]) {
        const myList = gistData.users[partner].sacrifices.filter(s => s.from === currentUser);
        myList.forEach(s => {
          let d = document.createElement("div");
          d.className = "sacrifice";
          d.textContent = `${s.desc} (${s.points} pts)`;
          myDiv.appendChild(d);
        });
      }

      const assignedDiv = document.getElementById("assignedSacrifices");
      assignedDiv.innerHTML = "";
      me.sacrifices.forEach((s, i) => {
        let d = document.createElement("div");
        d.className = "sacrifice";
        d.innerHTML = `${s.desc} (${s.points} pts) 
          <button onclick="completeSacrifice(${i})">Mark Done</button>`;
        assignedDiv.appendChild(d);
      });
    }

    function renderHistory() {
      const me = gistData.users[currentUser];
      const hDiv = document.getElementById("history");
      hDiv.innerHTML = "";
      me.history.forEach(h => {
        let d = document.createElement("div");
        d.className = "sacrifice";
        d.textContent = `${h.desc} - ${h.points} pts (confirmed by ${h.by})`;
        hDiv.appendChild(d);
      });
    }

    async function buyCertificate() {
      const type = parseInt(document.getElementById("certType").value);
      const content = document.getElementById("certContent").value.trim().split("\n");
      const partner = document.getElementById("certPartner").value.trim();
      const me = gistData.users[currentUser];
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${now.getMonth()}`;

      const certsThisMonth = me.certificates.filter(c => c.monthKey === monthKey).length;
      if (certsThisMonth >= 2) return alert("Max 2 certificates per month reached");

      if (me.points < type) return alert("Not enough points");

      me.points -= type;
      me.certificates.push({ date: now.toISOString(), monthKey, type, partner, content });
      await updateGist();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("Certificate of Sacrifice", 20, 20);
      doc.setFontSize(12);
      doc.text(`Awarded to: ${partner}`, 20, 35);
      doc.text(`From: ${currentUser}`, 20, 45);
      doc.text(`Level: ${type} Points`, 20, 55);
      doc.text("Custom Challenges:", 20, 70);
      content.forEach((line, i) => {
        doc.text(`- ${line}`, 25, 80 + i * 10);
      });
      doc.save(`certificate_${currentUser}_${partner}.pdf`);

      showDashboard();
    }

    window.onload = async () => {
      await fetchToken();
      gistData = await fetchGistData();
      const savedUser = localStorage.getItem("currentUser");
      if (savedUser && gistData.users[savedUser]) {
        currentUser = savedUser;
        showDashboard();
      } else {
        document.getElementById("loginDiv").style.display='block';
      }
    };
  </script>
</body>
</html>