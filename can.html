<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Love Challenge Game</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #ffe6f0; margin:0; padding:0; }
.container { max-width: 600px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
button { background: #ff4d94; color: white; cursor: pointer; font-weight: bold; }
button:hover { background: #e60073; }
h2, h3 { color: #ff3385; margin-bottom: 10px; }
.section { margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; }
.card { background:#fff5f9; padding:10px; border-radius:8px; margin-bottom:8px; }
</style>
</head>
<body>

<div class="container" id="loginDiv">
  <h2>Login / Register</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login / Register</button>
  <p id="status"></p>
</div>

<div class="container" id="mainDiv" style="display:none;">
  <h2>Love Dashboard</h2>
  <p>Logged in as: <span id="currentUser"></span></p>
  <p>Your Points: <span id="pointsDisplay">0</span></p>

  <div class="section">
    <h3>Partner Setup</h3>
    <select id="partnerSelect"></select>
    <button onclick="setPartner()">Save Partner</button>
    <p id="partnerStatus"></p>
  </div>

  <div class="section">
    <h3>Create Sacrifice for Partner</h3>
    <input type="text" id="sacrificeDesc" placeholder="Sacrifice description">
    <input type="number" id="sacrificePoints" placeholder="Points (10, 20, 30)">
    <button onclick="createSacrifice()">Create Sacrifice</button>
  </div>

  <div class="section">
    <h3>Tasks for You</h3>
    <div id="tasksForYou"></div>
  </div>

  <div class="section">
    <h3>History (Completed Sacrifices)</h3>
    <div id="historyList"></div>
  </div>

  <div class="section">
    <h3>Certificates</h3>
    <input type="text" id="certTitle" placeholder="Certificate title">
    <select id="certType">
      <option value="Question">Question</option>
      <option value="Dare">Dare</option>
    </select>
    <button onclick="buyCertificate(10)">Buy (10 pts)</button>
    <button onclick="buyCertificate(20)">Buy (20 pts)</button>
    <button onclick="buyCertificate(30)">Buy (30 pts)</button>
    <p id="certStatus"></p>
  </div>
</div>

<script>
const gistID = "b8d0eca0d174ac6b5b59c2ced0a9e2ad";
const gistFileName = "gist_1.json";
const gistRawURL = `https://gist.githubusercontent.com/Preasx24/${gistID}/raw/${gistFileName}`;
const tokenGistURL = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

let gistToken = "";
let gistData = {};
let currentUser = "";

async function fetchToken() {
  const res = await fetch(tokenGistURL);
  gistToken = (await res.text()).split("\n")[0].trim();
}

async function fetchGist() {
  const res = await fetch(gistRawURL + "?t=" + Date.now());
  let data = await res.json();
  if (!data.users) data = { users:{} };
  return data;
}

async function saveGist() {
  if (!gistToken) await fetchToken();
  await fetch(`https://api.github.com/gists/${gistID}`, {
    method: "PATCH",
    headers: { "Authorization": `token ${gistToken}`, "Content-Type":"application/json" },
    body: JSON.stringify({
      files: { [gistFileName]: { content: JSON.stringify(gistData,null,2) } }
    })
  });
}

// --- LOGIN ---
async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) return alert("Enter both fields");

  gistData = await fetchGist();
  if (!gistData.users[username]) {
    gistData.users[username] = { password, points:0, partner:"", sacrifices:[], history:[], certificates:[] };
    await saveGist();
  } else if (gistData.users[username].password !== password) {
    return alert("Incorrect password");
  }

  currentUser = username;
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("mainDiv").style.display="block";
  refreshUI();
  populatePartners();
}

// --- PARTNER SETUP ---
function populatePartners() {
  const sel = document.getElementById("partnerSelect");
  sel.innerHTML = "";
  Object.keys(gistData.users).forEach(u=>{
    if (u!==currentUser) {
      const opt=document.createElement("option");
      opt.value=u;
      opt.textContent=u;
      if (gistData.users[currentUser].partner===u) opt.selected=true;
      sel.appendChild(opt);
    }
  });
}

async function setPartner() {
  const partner = document.getElementById("partnerSelect").value;
  if (!partner) return alert("Choose a partner");
  gistData.users[currentUser].partner = partner;
  gistData.users[partner].partner = currentUser;
  await saveGist();
  document.getElementById("partnerStatus").textContent="Partner set as " + partner;
  refreshUI();
}

// --- SACRIFICES ---
async function createSacrifice() {
  const desc = document.getElementById("sacrificeDesc").value.trim();
  const pts = parseInt(document.getElementById("sacrificePoints").value);
  if (!desc || ![10,20,30].includes(pts)) return alert("Invalid input");
  const partner = gistData.users[currentUser].partner;
  if (!partner) return alert("No partner set");

  gistData.users[partner].sacrifices.push({desc, points:pts, from:currentUser});
  await saveGist();
  document.getElementById("sacrificeDesc").value="";
  document.getElementById("sacrificePoints").value="";
  refreshUI();
}

async function completeSacrifice(index) {
  const me = gistData.users[currentUser];
  const sac = me.sacrifices[index];
  me.points += sac.points;
  me.history.push(sac);
  me.sacrifices.splice(index,1);
  await saveGist();
  refreshUI();
}

// --- CERTIFICATES ---
async function buyCertificate(cost) {
  const me = gistData.users[currentUser];
  if (me.points < cost) return alert("Not enough points");
  const title=document.getElementById("certTitle").value.trim();
  const type=document.getElementById("certType").value;
  const partner=me.partner;
  if (!title || !partner) return alert("Fill all fields + have partner set");

  me.points -= cost;
  me.certificates.push({title, type, partner, cost});
  await saveGist();
  refreshUI();
  generatePDF(title, type, partner, cost);
}

function generatePDF(title,type,partner,cost) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(22);
  doc.text("Love Certificate", 70, 30);
  doc.setFontSize(16);
  doc.text(`Awarded to: ${partner}`, 20, 60);
  doc.text(`From: ${currentUser}`, 20, 70);
  doc.text(`Type: ${type}`, 20, 90);
  doc.text(`Title: ${title}`, 20, 100);
  doc.text(`Points Used: ${cost}`, 20, 110);
  doc.text("Certified with ❤️", 20, 140);
  doc.save(`${title}.pdf`);
}

// --- REFRESH UI ---
function refreshUI() {
  const me = gistData.users[currentUser];
  document.getElementById("currentUser").textContent=currentUser;
  document.getElementById("pointsDisplay").textContent=me.points;

  const tasksDiv=document.getElementById("tasksForYou");
  tasksDiv.innerHTML="";
  me.sacrifices.forEach((s,i)=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<b>${s.desc}</b> (${s.points} pts, from ${s.from})
    <button onclick="completeSacrifice(${i})">Mark Done</button>`;
    tasksDiv.appendChild(c);
  });

  const hist=document.getElementById("historyList");
  hist.innerHTML="";
  me.history.forEach(h=>{
    const c=document.createElement("div");
    c.className="card";
    c.textContent=`${h.desc} (${h.points} pts) from ${h.from}`;
    hist.appendChild(c);
  });
}
</script>

</body>
</html>