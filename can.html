<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Love Certificates</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; color:#333; padding:20px; }
    .card { background:white; border-radius:12px; padding:20px; margin:20px auto; max-width:500px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    button { background:#ff477e; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; margin-top:10px; }
    button:hover { background:#e63e70; }
    input, select, textarea { width:100%; padding:8px; margin:5px 0 15px; border:1px solid #ddd; border-radius:6px; }
  </style>
</head>
<body>
  <h1>ðŸ’• Love Certificates</h1>
  
  <div id="loginCard" class="card">
    <h2>Login</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login / Register</button>
  </div>

  <div id="mainCard" class="card" style="display:none;">
    <h2>Welcome, <span id="currentUser"></span></h2>
    <p>Your Points: <span id="points">0</span></p>

    <h3>Create Sacrifice for Partner</h3>
    <input id="sacrificeText" placeholder="Describe sacrifice">
    <input id="sacrificePoints" type="number" placeholder="Points">
    <button onclick="createSacrifice()">Add Sacrifice</button>

    <h3>Sacrifices You Must Do</h3>
    <ul id="receivedList"></ul>

    <h3>Buy Certificate</h3>
    <select id="certificateType">
      <option value="10">10 pts - Questions</option>
      <option value="20">20 pts - Easy Date</option>
      <option value="30">30 pts - Serious Date</option>
    </select>
    <textarea id="certificateContent" placeholder="Write up to 10 questions or dares (one per line)"></textarea>
    <input id="certificatePartner" placeholder="Intended Partner">
    <button onclick="buyCertificate()">Generate Certificate</button>
  </div>

  <script>
    const gistUrl = "https://api.github.com/gists/b8d0eca0d174ac6b5b59c2ced0a9e2ad";
    const fileName = "gist_1.json";
    const tokenUrl = "https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt";

    let token = "";
    let gistData = {};
    let currentUser = null;

    async function fetchToken() {
      const res = await fetch(tokenUrl);
      token = await res.text();
    }

    async function loadGist() {
      const res = await fetch(gistUrl, { headers: { Authorization: "token " + token }});
      const data = await res.json();
      gistData = JSON.parse(data.files[fileName].content || '{"users":{}}');
    }

    async function saveGist() {
      await fetch(gistUrl, {
        method: "PATCH",
        headers: { "Authorization": "token " + token, "Content-Type": "application/json" },
        body: JSON.stringify({
          files: { [fileName]: { content: JSON.stringify(gistData, null, 2) } }
        })
      });
    }

    async function login() {
      await fetchToken();
      await loadGist();
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      if (!user || !pass) return alert("Fill username and password");
      
      if (!gistData.users[user]) {
        gistData.users[user] = { password: pass, points: 0, partner: null, sacrificesGiven: [], sacrificesReceived: [], history: [] };
      }
      if (gistData.users[user].password !== pass) return alert("Wrong password");
      currentUser = user;
      await saveGist();
      document.getElementById("loginCard").style.display="none";
      document.getElementById("mainCard").style.display="block";
      document.getElementById("currentUser").textContent = user;
      refreshUI();
    }

    async function createSacrifice() {
      const text = document.getElementById("sacrificeText").value.trim();
      const pts = parseInt(document.getElementById("sacrificePoints").value);
      const partner = gistData.users[currentUser].partner;
      if (!partner) return alert("No partner assigned!");
      if (!text || !pts) return alert("Fill details");
      const s = { text, points: pts, from: currentUser };
      gistData.users[partner].sacrificesReceived.push(s);
      gistData.users[currentUser].sacrificesGiven.push(s);
      await saveGist();
      document.getElementById("sacrificeText").value="";
      document.getElementById("sacrificePoints").value="";
      refreshUI();
    }

    async function completeSacrifice(index) {
      const s = gistData.users[currentUser].sacrificesReceived[index];
      gistData.users[currentUser].points += s.points;
      gistData.users[currentUser].history.push(s);
      gistData.users[s.from].history.push(s);
      gistData.users[currentUser].sacrificesReceived.splice(index,1);
      await saveGist();
      refreshUI();
    }

    function refreshUI() {
      document.getElementById("points").textContent = gistData.users[currentUser].points;
      const list = document.getElementById("receivedList");
      list.innerHTML="";
      gistData.users[currentUser].sacrificesReceived.forEach((s,i)=>{
        const li = document.createElement("li");
        li.textContent = s.text+" ("+s.points+" pts) from "+s.from;
        const b = document.createElement("button");
        b.textContent = "Mark Done";
        b.onclick = ()=>completeSacrifice(i);
        li.appendChild(b);
        list.appendChild(li);
      });
    }

    async function buyCertificate() {
      const type = parseInt(document.getElementById("certificateType").value);
      const content = document.getElementById("certificateContent").value.trim().split("\n").filter(l=>l);
      const partner = document.getElementById("certificatePartner").value.trim();
      if (gistData.users[currentUser].points < type) return alert("Not enough points");
      gistData.users[currentUser].points -= type;
      await saveGist();
      generatePDF(type, content, partner);
      refreshUI();
    }

    function generatePDF(type, content, partner) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("Certificate of Love", 70, 20);
      doc.setFontSize(12);
      doc.text("This certificate is granted by: "+currentUser, 20, 40);
      doc.text("To: "+partner, 20, 50);
      doc.text("Certificate Level: "+type+" pts", 20, 60);
      doc.text("Challenges / Questions / Dares:", 20, 75);
      content.forEach((c,i)=> doc.text((i+1)+". "+c, 25, 90+i*10));
      doc.save("certificate_"+currentUser+".pdf");
    }
  </script>
</body>
</html>