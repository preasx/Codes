<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Love Challenge Game</title>
<style>
body { font-family: Arial, sans-serif; background: #ffe6f0; margin:0; padding:0; }
.container { max-width: 500px; margin: 50px auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
button { background: #ff4d94; color: white; cursor: pointer; }
button:hover { background: #ff1a75; }
.section { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px; }
h3 { color: #ff4d94; }
ul { padding-left: 20px; }
li { margin-bottom: 5px; }
</style>
</head>
<body>

<div class="container" id="loginDiv">
<h2>Login / Register</h2>
<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Login / Register</button>
<p id="status"></p>
</div>

<div class="container" id="mainDiv" style="display:none;">
<h2>Love Challenge Dashboard</h2>
<p>Logged in as: <span id="currentUser"></span></p>
<p>Your Points: <span id="pointsDisplay">0</span></p>

<div class="section">
<h3>Select Partner</h3>
<select id="partnerSelect" onchange="loadPartnerData()">
<option value="">Select Partner</option>
</select>
</div>

<div class="section" id="sacrificesDiv" style="display:none;">
<h3>Create a Sacrifice</h3>
<input type="text" id="sacrificeDesc" placeholder="Sacrifice description">
<input type="number" id="sacrificePoints" placeholder="Points (10, 20, 30)">
<button onclick="createSacrifice()">Create Sacrifice</button>
<h4>Pending Sacrifices to Complete for Partner</h4>
<ul id="partnerSacrificesList"></ul>
</div>

<div class="section" id="certificatesDiv" style="display:none;">
<h3>Buy Certificate</h3>
<button onclick="buyCertificate(10)">10 Points Certificate (Questions)</button>
<button onclick="buyCertificate(20)">20 Points Certificate (Questions + Easy Date)</button>
<button onclick="buyCertificate(30)">30 Points Certificate (Private Date + Serious Questions)</button>
<p id="certStatus"></p>
</div>

<script>
const gistID = 'b8d0eca0d174ac6b5b59c2ced0a9e2ad';
const gistFileName = 'gist_1.json';
const gistRawURL = `https://gist.githubusercontent.com/Preasx24/${gistID}/raw/${gistFileName}`;
const tokenGistURL = 'https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt';

let gistToken = '';
let userData = {};
let currentUser = '';
let currentPartner = '';

// --- FETCH TOKEN FROM TOKEN GIST ---
async function fetchToken() {
    if(gistToken) return gistToken;
    try {
        const res = await fetch(tokenGistURL);
        const text = await res.text();
        gistToken = text.split('\n')[0].trim();
        return gistToken;
    } catch(e) {
        alert('Failed to fetch GitHub token.');
        console.error(e);
    }
}

// --- FETCH OR INITIALIZE GIST DATA ---
async function fetchGistData() {
    try {
        const res = await fetch(gistRawURL);
        let data = await res.json();
        if(!data.users) data = { users:{} };
        return data;
    } catch(e) {
        return { users:{} };
    }
}

// --- UPDATE GIST DATA ---
async function updateGistData() {
    await fetchToken();
    await fetch(`https://api.github.com/gists/${gistID}`, {
        method: 'PATCH',
        headers: {
            'Authorization': `token ${gistToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            files: {
                [gistFileName]: { content: JSON.stringify(userData,null,2) }
            }
        })
    });
}

// --- LOGIN & REGISTER ---
async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!username || !password) return alert('Enter both fields');

    userData = await fetchGistData();
    if(!userData.users) userData.users={};

    if(!userData.users[username]) {
        // register
        userData.users[username] = { password, points:0, sacrifices:[], certificates:[] };
        await updateGistData();
    } else if(userData.users[username].password !== password) {
        return alert('Incorrect password');
    }

    currentUser = username;
    showDashboard();
}

// --- DASHBOARD ---
function showDashboard() {
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('mainDiv').style.display='block';
    document.getElementById('currentUser').innerText=currentUser;
    document.getElementById('pointsDisplay').innerText=userData.users[currentUser].points;

    const partnerSelect = document.getElementById('partnerSelect');
    partnerSelect.innerHTML='<option value="">Select Partner</option>';
    Object.keys(userData.users).forEach(u=>{
        if(u!==currentUser) partnerSelect.innerHTML+=`<option value="${u}">${u}</option>`;
    });
}

// --- PARTNER DATA ---
function loadPartnerData() {
    currentPartner = document.getElementById('partnerSelect').value;
    if(!currentPartner) return;

    if(!userData.users[currentPartner].sacrifices) userData.users[currentPartner].sacrifices=[];
    if(!userData.users[currentPartner].certificates) userData.users[currentPartner].certificates=[];
    renderPartnerSacrifices();
    document.getElementById('sacrificesDiv').style.display='block';
    document.getElementById('certificatesDiv').style.display='block';
}

function renderPartnerSacrifices() {
    const ul = document.getElementById('partnerSacrificesList');
    ul.innerHTML='';
    const sacrifices = userData.users[currentPartner].sacrifices;
    sacrifices.forEach((s,index)=>{
        const li=document.createElement('li');
        li.innerHTML=`${s.desc} - ${s.points} points <button onclick="markSacrificeComplete(${index})">Mark Completed</button>`;
        ul.appendChild(li);
    });
}

// --- CREATE SACRIFICE ---
async function createSacrifice() {
    const desc = document.getElementById('sacrificeDesc').value.trim();
    const points = parseInt(document.getElementById('sacrificePoints').value);
    if(!desc || ![10,20,30].includes(points)) return alert('Enter description and valid points (10,20,30)');
    if(!currentPartner) return alert('Select a partner first');

    userData.users[currentUser].sacrifices.push({desc, points, partner: currentPartner, completed:false});
    await updateGistData();
    alert('Sacrifice created!');
    document.getElementById('sacrificeDesc').value='';
    document.getElementById('sacrificePoints').value='';
    renderPartnerSacrifices();
}

// --- COMPLETE SACRIFICE ---
async function markSacrificeComplete(index) {
    const sac = userData.users[currentPartner].sacrifices[index];
    if(!confirm(`Confirm with ${currentPartner} that this sacrifice is completed?`)) return;
    // Award points
    userData.users[currentUser].points += sac.points;
    // Remove sacrifice
    userData.users[currentPartner].sacrifices.splice(index,1);
    await updateGistData();
    document.getElementById('pointsDisplay').innerText=userData.users[currentUser].points;
    renderPartnerSacrifices();
    alert('Points awarded and sacrifice removed!');
}

// --- BUY CERTIFICATE ---
async function buyCertificate(level) {
    if(userData.users[currentUser].points<level) return alert('Not enough points');
    userData.users[currentUser].points -= level;
    await updateGistData();
    document.getElementById('pointsDisplay').innerText=userData.users[currentUser].points;
    let msg='';
    if(level===10) msg='10 points certificate: Questions only';
    if(level===20) msg='20 points certificate: Questions + Easy Date';
    if(level===30) msg='30 points certificate: Private Date + Serious Questions';
    document.getElementById('certStatus').innerText=`Purchased: ${msg}`;
}
</script>

</body>
</html>