<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Together - Activity Sharing</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(to right, #6e8efb, #a777e3);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 25px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border-radius: 15px;
      background: #f8f9fa;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    h2 {
      color: #6e8efb;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eaeaea;
    }
    
    .user-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .user-card {
      flex: 1;
      min-width: 200px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .user-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    
    .user-card.selected {
      background: #6e8efb;
      color: white;
    }
    
    .user-card h3 {
      margin-bottom: 10px;
    }
    
    .activities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .activity-btn {
      background: white;
      border: 2px solid #6e8efb;
      border-radius: 10px;
      padding: 15px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      text-align: center;
    }
    
    .activity-btn:hover {
      background: #6e8efb;
      color: white;
      transform: scale(1.05);
    }
    
    .partner-activities {
      margin-top: 20px;
    }
    
    .activity-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    .activity-type {
      font-weight: 600;
      color: #6e8efb;
    }
    
    .activity-time {
      color: #777;
      font-size: 0.9rem;
    }
    
    .btn {
      background: #6e8efb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      background: #5a7dfa;
      transform: translateY(-2px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-refresh {
      background: #a777e3;
      display: block;
      width: 100%;
      margin-top: 20px;
    }
    
    .btn-refresh:hover {
      background: #9666d3;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .status-bar {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .status-connected {
      background: #4CAF50;
    }
    
    .status-disconnected {
      background: #F44336;
    }
    
    .status-loading {
      background: #FFC107;
    }
    
    footer {
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .activities-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .user-card {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Together</h1>
      <p class="subtitle">Share what you're doing with your partner</p>
    </header>
    
    <div class="content">
      <div class="section">
        <h2>Select Your Username</h2>
        <p>Choose your username to ensure activities are saved to your personal gist:</p>
        
        <div class="user-selection">
          <div class="user-card" onclick="selectUser('lefa')">
            <h3>lefa</h3>
            <p>Personal Gist Available</p>
          </div>
          <div class="user-card" onclick="selectUser('jonas')">
            <h3>jonas</h3>
            <p>Personal Gist Available</p>
          </div>
          <div class="user-card" onclick="selectUser('owami')">
            <h3>owami</h3>
            <p>Personal Gist Available</p>
          </div>
          <div class="user-card" onclick="selectUser('preasx24')">
            <h3>preasx24</h3>
            <p>Personal Gist Available</p>
          </div>
        </div>
        
        <div class="status-bar">
          <div class="status-dot status-loading" id="statusDot"></div>
          <span id="statusText">Select your username to begin</span>
        </div>
      </div>
      
      <div class="section">
        <h2>Share Your Activity</h2>
        <p>Select an activity to share with your partner:</p>
        
        <div class="activities-grid">
          <div class="activity-btn" onclick="shareActivity('pooping')">Pooping üí©</div>
          <div class="activity-btn" onclick="shareActivity('eating')">Eating üçΩÔ∏è</div>
          <div class="activity-btn" onclick="shareActivity('working')">Working üíº</div>
          <div class="activity-btn" onclick="shareActivity('sleeping')">Sleeping üò¥</div>
          <div class="activity-btn" onclick="shareActivity('exercising')">Exercising üèÉ</div>
          <div class="activity-btn" onclick="shareActivity('thinking')">Thinking of You üí≠</div>
          <div class="activity-btn" onclick="shareActivity('shopping')">Shopping üõçÔ∏è</div>
          <div class="activity-btn" onclick="shareActivity('watching')">Watching TV üì∫</div>
          <div class="activity-btn" onclick="shareActivity('cooking')">Cooking üë©‚Äçüç≥</div>
          <div class="activity-btn" onclick="shareActivity('driving')">Driving üöó</div>
          <div class="activity-btn" onclick="shareActivity('missing')">Missing You üíî</div>
          <div class="activity-btn" onclick="shareActivity('celebrating')">Celebrating üéâ</div>
        </div>
      </div>
      
      <div class="section">
        <h2>Partner's Recent Activities</h2>
        <p>Latest activities shared by your partner:</p>
        
        <div id="partnerActivities">
          <div class="activity-item">
            <div class="activity-type">No activities yet</div>
            <div class="activity-time">-</div>
          </div>
        </div>
        
        <button class="btn btn-refresh" onclick="loadPartnerActivities()">Refresh Activities</button>
      </div>
    </div>
    
    <footer>
      <p>Together App ‚Ä¢ Share moments with your loved ones</p>
    </footer>
  </div>
  
  <div class="notification" id="notification">
    <span id="notificationText"></span>
  </div>

  <script>
    const gistUrls = {
      activities: 'https://gist.githubusercontent.com/Preasx24/4f0b769f591da88eb60147bd5a3d044c/raw/gistfile1.txt',
      token: 'https://gist.githubusercontent.com/Preasx24/e8b6e2c45a6963ef3c5f4a24704ab5fb/raw/gistfile1.txt'
    };

    // Map usernames to their personal gists
    const userGistMap = {
      lefa: "https://gist.githubusercontent.com/Preasx24/02e300379f8b968942ac67379f5bc831/raw/gist_1.json",
      jonas: "https://gist.githubusercontent.com/Preasx24/69f058ad6bcb25e41d8b797dc7395c6d/raw/gist_2.json",
      owami: "https://gist.githubusercontent.com/Preasx24/6c9e9fcda5ed38f9839c9ac8bc147ba7/raw/gist_3.json",
      preasx24: "https://gist.githubusercontent.com/Preasx24/50e60ff2c3bc108d63038c8eb6c26e8d/raw/gist_4.json"
    };

    // Map usernames to their user keys (for main gist)
    const userKeyMap = {
      lefa: "user1",
      jonas: "user2",
      owami: "user3",
      preasx24: "user4"
    };

    // Map usernames to their partner keys (for reading partner's activities)
    const partnerKeyMap = {
      lefa: "partner1",
      jonas: "partner2",
      owami: "partner3",
      preasx24: "partner4"
    };

    let userData = {
      username: null,
      userKey: null,
      partnerKey: null,
      personalGistUrl: null,
      gistToken: null,
      activities: []
    };

    function selectUser(username) {
      // Update UI
      const userCards = document.querySelectorAll('.user-card');
      userCards.forEach(card => card.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      
      // Update user data
      userData.username = username;
      userData.userKey = userKeyMap[username] || "defaultUser";
      userData.partnerKey = partnerKeyMap[username] || "defaultPartner";
      userData.personalGistUrl = userGistMap[username];
      
      // Update status
      updateStatus('connected', `Connected as ${username}`);
      
      // Save to localStorage
      localStorage.setItem('togetherProfile', JSON.stringify(userData));
      
      // Load token and activities
      loadGithubToken();
      loadPartnerActivities();
      
      showNotification(`You are now connected as ${username}`);
    }

    function updateStatus(status, message) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      statusDot.className = 'status-dot';
      switch(status) {
        case 'connected':
          statusDot.classList.add('status-connected');
          break;
        case 'disconnected':
          statusDot.classList.add('status-disconnected');
          break;
        case 'loading':
          statusDot.classList.add('status-loading');
          break;
      }
      
      statusText.textContent = message;
    }

    async function loadGithubToken() {
      try {
        updateStatus('loading', 'Loading GitHub token...');
        const response = await fetch(gistUrls.token + '?t=' + new Date().getTime());
        const token = await response.text();
        userData.gistToken = token.trim();
        updateStatus('connected', `Connected as ${userData.username}`);
      } catch (error) {
        console.error('Error loading GitHub token:', error);
        updateStatus('disconnected', 'Failed to load GitHub token');
        showNotification('Error loading GitHub token');
      }
    }

    async function shareActivity(activity) {
      if (!userData.username) {
        showNotification('Please select your username first');
        return;
      }
      
      if (!userData.gistToken) {
        showNotification('GitHub token not loaded yet. Please wait...');
        return;
      }

      // Create activity object
      const newActivity = {
        type: activity,
        timestamp: new Date().toISOString()
      };

      // Add to local activities
      userData.activities.push(newActivity);
      if (userData.activities.length > 20) {
        userData.activities = userData.activities.slice(-20);
      }

      // Save to localStorage
      localStorage.setItem('togetherProfile', JSON.stringify(userData));

      try {
        // Update main gist (original functionality)
        const mainGistSuccess = await updateMainGist({
          [userData.userKey]: {
            activities: userData.activities,
            updated: new Date().toISOString()
          }
        });

        // Update personal gist (new functionality)
        const personalGistSuccess = await updatePersonalActivityGist(newActivity);

        if (mainGistSuccess && personalGistSuccess) {
          showNotification('Activity shared: ' + formatActivityType(activity));
        } else if (mainGistSuccess) {
          showNotification('Activity shared to main feed, but personal gist update failed');
        } else {
          showNotification('Failed to share activity');
        }
      } catch (error) {
        console.error('Error sharing activity:', error);
        showNotification('Error sharing activity: ' + error.message);
      }
    }

    async function loadPartnerActivities() {
      try {
        updateStatus('loading', 'Loading partner activities...');
        const response = await fetch(gistUrls.activities + '?t=' + new Date().getTime());
        const data = await response.json();
        const activitiesContainer = document.getElementById('partnerActivities');
        activitiesContainer.innerHTML = '';

        if (data && data[userData.partnerKey] && data[userData.partnerKey].activities && data[userData.partnerKey].activities.length > 0) {
          const activities = data[userData.partnerKey].activities;
          activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const recentActivities = activities.slice(0, 5);

          recentActivities.forEach(activity => {
            const timeDiff = Math.floor((new Date() - new Date(activity.timestamp)) / 60000);
            let timeText = '';
            if (timeDiff < 1) timeText = 'just now';
            else if (timeDiff < 60) timeText = `${timeDiff} minutes ago`;
            else timeText = `${Math.floor(timeDiff/60)} hours ago`;

            const activityEl = document.createElement('div');
            activityEl.className = 'activity-item';
            activityEl.innerHTML = `
              <div class="activity-type">${formatActivityType(activity.type)}</div>
              <div class="activity-time">${timeText}</div>
            `;
            activitiesContainer.appendChild(activityEl);
          });
        } else {
          activitiesContainer.innerHTML = `
            <div class="activity-item">
              <div class="activity-type">No activities yet</div>
              <div class="activity-time">-</div>
            </div>
          `;
        }
        
        updateStatus('connected', `Connected as ${userData.username}`);
      } catch (error) {
        console.error('Error fetching partner activities:', error);
        updateStatus('disconnected', 'Failed to load activities');
        showNotification('Error fetching partner activities');
      }
    }

    function formatActivityType(type) {
      const activityMap = {
        'pooping': 'Pooping üí©',
        'eating': 'Eating üçΩÔ∏è',
        'working': 'Working üíº',
        'sleeping': 'Sleeping üò¥',
        'exercising': 'Exercising üèÉ',
        'thinking': 'Thinking of You üí≠',
        'shopping': 'Shopping üõçÔ∏è',
        'watching': 'Watching TV üì∫',
        'cooking': 'Cooking üë©‚Äçüç≥',
        'driving': 'Driving üöó',
        'missing': 'Missing You üíî',
        'celebrating': 'Celebrating üéâ'
      };
      return activityMap[type] || type;
    }

    // Original main gist update function
    async function updateMainGist(data) {
      if (!userData.gistToken) {
        showNotification('GitHub token is required to update Gists');
        return false;
      }

      try {
        const gistId = gistUrls.activities.split('/')[4];
        const currentResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: { 'Authorization': `token ${userData.gistToken}` }
        });

        if (!currentResponse.ok) {
          throw new Error(`HTTP error! status: ${currentResponse.status}`);
        }

        const currentGist = await currentResponse.json();
        let currentContent = {};
        try {
          currentContent = JSON.parse(currentGist.files['gistfile1.txt'].content);
        } catch (e) {
          console.log('Starting fresh Gist content');
        }

        const newContent = { ...currentContent, ...data };

        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${userData.gistToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              'gistfile1.txt': { content: JSON.stringify(newContent, null, 2) }
            }
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return true;
      } catch (error) {
        console.error('Error updating main Gist:', error);
        showNotification('Error updating main Gist: ' + error.message);
        return false;
      }
    }

    // Personal gist update function
    async function updatePersonalActivityGist(activity) {
      if (!userData.personalGistUrl) {
        console.log('No personal gist URL for user:', userData.username);
        return false;
      }

      try {
        const parts = userData.personalGistUrl.split('/');
        const gistId = parts[4];
        const fileName = parts[parts.length - 1];

        const currentResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: { 'Authorization': `token ${userData.gistToken}` }
        });

        if (!currentResponse.ok) {
          throw new Error(`HTTP error! status: ${currentResponse.status}`);
        }

        const currentGist = await currentResponse.json();
        let currentContent = {};
        
        try {
          const content = currentGist.files[fileName].content;
          // Handle both array format (legacy) and object format
          if (content.trim() === '[]') {
            // Empty array - convert to object format
            currentContent = { activity: null };
          } else {
            currentContent = JSON.parse(content);
            // If it's an array, convert to object format
            if (Array.isArray(currentContent)) {
              currentContent = { activity: null };
            }
          }
        } catch (e) {
          console.log('Starting fresh personal Gist content');
          currentContent = { activity: null };
        }

        // Update only the activity field
        currentContent.activity = activity;

        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${userData.gistToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              [fileName]: { content: JSON.stringify(currentContent, null, 2) }
            }
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        console.log('Personal gist updated successfully');
        return true;
      } catch (error) {
        console.error("Error updating personal gist:", error);
        showNotification("Error updating personal gist: " + error.message);
        return false;
      }
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      notificationText.textContent = message;
      notification.classList.add('show');
      setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }

    // Initialize the app
    function initApp() {
      const savedProfile = localStorage.getItem('togetherProfile');
      if (savedProfile) {
        userData = JSON.parse(savedProfile);
        if (userData.username) {
          // Select the user in UI
          const userCards = document.querySelectorAll('.user-card');
          for (let card of userCards) {
            if (card.querySelector('h3').textContent === userData.username) {
              card.classList.add('selected');
              break;
            }
          }
          
          updateStatus('connected', `Connected as ${userData.username}`);
          loadGithubToken();
          loadPartnerActivities();
        }
      }
    }

    window.onload = initApp;
  </script>
</body>
</html>